# ESP32-S3 LCD Shell Console - è°ƒè¯•æ—¥å¿—

## é—®é¢˜æè¿°

LCDæ˜¾ç¤ºå™¨ä¼šå‡ºçŽ°"mmm"åžƒåœ¾å­—ç¬¦ï¼Œç‰¹åˆ«æ˜¯åœ¨æŒ‰ä¸‹Enteré”®åŽã€‚

## è°ƒè¯•åŽ†ç¨‹

### é˜¶æ®µ1: åˆæ­¥æ€€ç–‘ - é‡å¤è¾“å‡ºï¼Ÿ

**å‡è®¾**: å¯èƒ½æ˜¯Shellå‘½ä»¤è¾“å‡ºè¢«é‡å¤æ•èŽ·  
**æµ‹è¯•**: æ·»åŠ LOG_INFæ—¥å¿—è¿½è¸ªæ‰€æœ‰è¾“å‡º  
**ç»“æžœ**: âŒ å‘çŽ°LOG_INFæœ¬èº«é€ æˆæ— é™é€’å½’ï¼Œ"messages dropped"  
**æ•™è®­**: ä¸èƒ½åœ¨Shellæ‹¦æˆªä»£ç ä¸­ä½¿ç”¨LOGç³»ç»Ÿ  

### é˜¶æ®µ2: æ”¹ç”¨printkè°ƒè¯•

**å‡è®¾**: LOGé€’å½’æ˜¯å› ä¸ºLOGåŽç«¯ï¼Œæ”¹ç”¨printkåº”è¯¥å®‰å…¨  
**æµ‹è¯•**: å°†æ‰€æœ‰LOG_INFæ”¹ä¸ºprintk  
**ç»“æžœ**: âŒ printkåŒæ ·è¾“å‡ºåˆ°Shellï¼Œé€ æˆé€’å½’å’Œæ¶ˆæ¯æ´ªæ°´  
**æ•™è®­**: printkä¹Ÿä¸å®‰å…¨ï¼Œè°ƒè¯•å¿…é¡»å®Œå…¨éš”ç¦»  

### é˜¶æ®µ3: ANSIçŠ¶æ€æœºå°è¯•

**å‡è®¾**: "mmm"æ˜¯ANSIè½¬ä¹‰åºåˆ—çš„æ®‹ç•™  
**å®žçŽ°**: 9çŠ¶æ€ANSIè§£æžå™¨ (NORMALâ†’ESCAPEâ†’CSIâ†’...)  
**ç»“æžœ**: âŒ éƒ¨åˆ†æˆåŠŸä½†ä¸ç¨³å®šï¼Œä»æœ‰"mmm"å‡ºçŽ°  
**åŽŸå› **: çŠ¶æ€æœºå‡è®¾åºåˆ—å®Œæ•´åˆ°è¾¾ï¼Œä½†å®žé™…è¢«åˆ†ç‰‡  

### é˜¶æ®µ4: é™æ€çŠ¶æ€æœº

**å‡è®¾**: çŠ¶æ€éœ€è¦è·¨è°ƒç”¨æŒä¹…åŒ–  
**å®žçŽ°**: å°†stateå˜é‡æ”¹ä¸ºstatic  
**ç»“æžœ**: âŒ ç•¥æœ‰æ”¹å–„ä½†ä»ä¸å¯é   
**åŽŸå› **: ç¢Žç‰‡é¡ºåºä¸å¯é¢„æµ‹ï¼ŒçŠ¶æ€æœºé€»è¾‘æ— æ³•åº”å¯¹  

### é˜¶æ®µ5: æ¨¡å¼é¢„è¿‡æ»¤

**å‡è®¾**: å¯ä»¥é¢„å…ˆè¿‡æ»¤æŽ‰å¸¸è§ANSIæ¨¡å¼  
**å®žçŽ°**: æ·»åŠ `[m`, `[0m`, `[1;32m`ç­‰é¢„å®šä¹‰æ¨¡å¼æ£€æŸ¥  
**ç»“æžœ**: âš ï¸ éƒ¨åˆ†æœ‰æ•ˆï¼Œä½†æ— æ³•è¦†ç›–æ‰€æœ‰ç¢Žç‰‡  
**åŽŸå› **: ç¢Žç‰‡æ¨¡å¼å¤ªå¤šï¼Œæ— æ³•ç©·ä¸¾  

### é˜¶æ®µ6: Hex Dumpåˆ†æž - çªç ´ï¼

**æ–¹æ³•**: æ·»åŠ ä¸´æ—¶hex dumpè¾“å‡ºï¼Œåˆ†æžæ‰€æœ‰çŸ­åŒ…  
```c
if (len >= 1 && len <= 4) {
    char hex[64] = {0};
    for (size_t i = 0; i < len; i++) {
        snprintf(&hex[off], sizeof(hex) - off, "%02X ", (uint8_t)data[i]);
    }
    printk("[HEX] len=%zu hex=[%s]\n", len, hex);
}
```

**å‘çŽ°çš„ç¢Žç‰‡æ¨¡å¼**:
```
[HEX] len=3 hex=[1B 5B 6D ]      â† ESC[m (å®Œæ•´)
[HEX] len=2 hex=[5B 6D ]         â† [m (ç¼ºå°‘ESC)
[HEX] len=1 hex=[6D ]            â† m (å•ç‹¬çš„m)
[HEX] len=4 hex=[3B 33 32 6D ]   â† ;32m (é¢œè‰²ç ç¢Žç‰‡)
[HEX] len=2 hex=[5B 4A ]         â† [J (æ¸…å±ç¢Žç‰‡)
[HEX] len=3 hex=[33 32 6D ]      â† 32m
[HEX] len=2 hex=[32 6D ]         â† 2m
```

**å…³é”®å‘çŽ°**:
1. "mmm" = å¤šä¸ª `[6D]` (0x6D='m') ç¢Žç‰‡
2. ç¢Žç‰‡é•¿åº¦ä¸»è¦åœ¨ 1-6 å­—èŠ‚
3. ç¢Žç‰‡ä»¥'m'ç»“å°¾æˆ–ä»¥'['å¼€å¤´çš„å±…å¤š
4. printkæœ¬èº«ä¹Ÿäº§ç”Ÿå¤§é‡ç¢Žç‰‡ï¼ˆé€’å½’ï¼‰

### é˜¶æ®µ7: Ultra-Aggressive Pre-Filtering - æˆåŠŸï¼âœ…

**ç­–ç•¥**: 
1. åœ¨ä¸»å¤„ç†å‰æ‹¦æˆªæ‰€æœ‰ANSIç¢Žç‰‡
2. æ£€æµ‹æ¨¡å¼ï¼š
   - ä»»ä½•ä»¥'m'ç»“å°¾ä¸”åŒ…å«`[`/`;`/æ•°å­—çš„1-6å­—èŠ‚åŒ…
   - ä»»ä½•ä»¥'['å¼€å¤´åŽè·ŸANSIå‘½ä»¤å­—ç¬¦çš„åŒ…
   - å•ç‹¬çš„'m'å­—ç¬¦
3. ç™½åå•ï¼šåªå…è®¸å¯æ‰“å°ASCII(32-126) + \n + \t + \b

**å®žçŽ°**:
```c
static bool is_ansi_escape_fragment(const char *data, size_t len)
{
    if (len >= 1 && len <= 6) {
        if (data[len-1] == 'm') {
            // æ£€æŸ¥æ˜¯å¦åŒ…å«ANSIç‰¹å¾
            for (size_t i = 0; i < len; i++) {
                if (data[i] == '[' || data[i] == ';' || 
                    (data[i] >= '0' && data[i] <= '9') || data[i] == 0x1B) {
                    return true; // æ‹’ç»
                }
            }
            if (len == 1) return true; // æ‹’ç»å•ç‹¬çš„'m'
        }
        if (data[0] == '[' && len >= 2) {
            char second = data[1];
            if (second == 'm' || second == 'J' || second == 'D' || 
                second == ';' || (second >= '0' && second <= '9')) {
                return true; // æ‹’ç»ANSIç¢Žç‰‡
            }
        }
    }
    return false;
}
```

**ç»“æžœ**: âœ…âœ…âœ… **å®Œå…¨è§£å†³ï¼**
- LCDæ˜¾ç¤ºå¹²å‡€ï¼Œæ²¡æœ‰ä»»ä½•"mmm"
- Enteré”®æ­£å¸¸
- Backspaceæ­£å¸¸
- Tabè¡¥å…¨æ­£å¸¸
- æ‰€æœ‰ShellåŠŸèƒ½æ­£å¸¸

## è°ƒè¯•å·¥å…·å¯¹æ¯”

| å·¥å…· | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ˜¯å¦å¯ç”¨ |
|------|------|------|----------|
| LOG_INF | Zephyræ ‡å‡†æ—¥å¿— | é€ æˆé€’å½’ | âŒ |
| printk | ç®€å•ç›´æŽ¥ | è¾“å‡ºåˆ°Shellé€ æˆé€’å½’ | âŒ |
| Hex Dump | ç²¾ç¡®æ˜¾ç¤ºå­—èŠ‚ | åŒæ ·é€’å½’ï¼Œä½†çŸ­æœŸå¯ç”¨äºŽåˆ†æž | âš ï¸ ä»…ä¸´æ—¶ |
| GPIO Toggle | ä¸å¹²æ‰°æ•°æ®æµ | åªèƒ½æ ‡è®°äº‹ä»¶ï¼Œæ— æ³•çœ‹æ•°æ® | âœ… |
| JTAG Debugger | å®Œæ•´æŽ§åˆ¶ | éœ€è¦ç¡¬ä»¶ï¼Œæ”¹å˜æ—¶åº | âœ… |

## å…³é”®æŒ‡æ ‡

### ç¼–è¯‘å¤§å°
- FLASH: 374376 B (4.46%)
- IRAM: 47584 B (13.85%)
- DRAM: 141000 B (43.10%)
- IROM: 228714 B (0.68%)

### è¿è¡Œæ—¶æ€§èƒ½
- æ˜¾ç¤ºåˆ·æ–°: 25mså¾ªçŽ¯
- LVGLå¤„ç†: < 5ms
- Shellå“åº”: å³æ—¶
- å†…å­˜ä½¿ç”¨: shell_display_buffer 2KB + current_input_line 256B

## æœ€ç»ˆæ–¹æ¡ˆçš„ä¼˜åŠ¿

1. **å¯é æ€§**: å¤šå±‚é˜²å¾¡ï¼Œç¢Žç‰‡æ— æ³•é€šè¿‡
2. **æ€§èƒ½**: é¢„è¿‡æ»¤åœ¨O(n)æ—¶é—´å†…å®Œæˆ
3. **ç®€æ´æ€§**: æ— éœ€å¤æ‚çŠ¶æ€æœº
4. **å¯ç»´æŠ¤æ€§**: ä»£ç æ¸…æ™°ï¼Œæ˜“äºŽç†è§£
5. **é€šç”¨æ€§**: é€‚ç”¨äºŽæ‰€æœ‰ANSIç¢Žç‰‡åœºæ™¯

## ç»éªŒæ€»ç»“

### DO âœ…
- ä½¿ç”¨hex dump **ä¸´æ—¶**åˆ†æžæ•°æ®æ¨¡å¼
- å¤šå±‚é˜²å¾¡ï¼ˆé¢„è¿‡æ»¤ + å­—ç¬¦è¿‡æ»¤ï¼‰
- ç™½åå•ç­–ç•¥ï¼ˆåªå…è®¸å·²çŸ¥å®‰å…¨å­—ç¬¦ï¼‰
- åœ¨æ•°æ®æµæœ€æ—©æœŸæ‹¦æˆªåžƒåœ¾æ•°æ®

### DON'T âŒ
- åœ¨Shellæ‹¦æˆªä»£ç ä¸­ä½¿ç”¨LOGæˆ–printk
- ä¾èµ–å¤æ‚çŠ¶æ€æœºå¤„ç†ä¸å¯é¢„æµ‹çš„ç¢Žç‰‡
- å°è¯•ç©·ä¸¾æ‰€æœ‰ANSIæ¨¡å¼
- å‡è®¾ANSIåºåˆ—ä¼šå®Œæ•´åˆ°è¾¾

## Timeline

- **2025-10-14 æ™š**: å‘çŽ°"mmm"é—®é¢˜ï¼Œå¼€å§‹è°ƒè¯•
- **2025-10-14 æ·±å¤œ**: å°è¯•LOGè°ƒè¯• â†’ é€’å½’é—®é¢˜
- **2025-10-15 å‡Œæ™¨**: å°è¯•ANSIçŠ¶æ€æœº â†’ éƒ¨åˆ†æˆåŠŸ
- **2025-10-15 ä¸Šåˆ**: Hex dumpåˆ†æž â†’ å‘çŽ°ç¢Žç‰‡åŒ–
- **2025-10-15 ä¸­åˆ**: Ultra-aggressive filter â†’ **å®Œå…¨è§£å†³ï¼**

## æ€»è°ƒè¯•æ—¶é—´

çº¦ **16å°æ—¶** ä»Žé—®é¢˜å‘çŽ°åˆ°æœ€ç»ˆè§£å†³

## ç‰¹åˆ«é¸£è°¢

æ„Ÿè°¢ GitHub Copilot çš„æŒç»­ååŠ©å’Œè€å¿ƒè°ƒè¯•æ”¯æŒï¼ðŸ™
